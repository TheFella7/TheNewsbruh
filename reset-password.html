<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - The News Bruh</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #000;
            --neon: #39FF14;
            --neon-dim: #1a5e0b;
            --error: #ff3939;
            --mono: 'Courier New', monospace;
        }
        body { 
            background: var(--bg); 
            color: var(--neon); 
            font-family: var(--mono); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0;
            text-shadow: 0 0 5px var(--neon-dim);
            border: 2px solid var(--neon);
        }
        .reset-box {
            width: 90%; max-width: 400px;
            border: 2px solid var(--neon);
            padding: 30px;
            background: #000;
            text-align: center;
            box-shadow: 0 0 20px var(--neon-dim);
        }
        h1 { margin-bottom: 10px; }
        .subtitle { font-size: 0.8rem; opacity: 0.7; margin-bottom: 25px; }
        input {
            width: 100%; padding: 12px; margin: 10px 0;
            background: #000; border: 1px solid var(--neon);
            color: var(--neon); font-family: var(--mono);
            text-align: center; outline: none;
        }
        button {
            width: 100%; padding: 12px; margin-top: 15px;
            background: var(--neon); color: #000;
            border: none; font-family: var(--mono);
            font-weight: bold; cursor: pointer;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .message { margin-top: 15px; font-size: 0.9rem; min-height: 20px; }
        .success { color: var(--neon); }
        .error { color: var(--error); }
        .back-link { 
            display: block; margin-top: 20px; 
            font-size: 0.8rem; color: var(--neon); 
            text-decoration: underline; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="reset-box">
        <h1>üîê RESET PASSWORD</h1>
        <div class="subtitle">THE NEWS BRUH // SECURE ACCESS RECOVERY</div>
        
        <!-- Step 1: Token verification (hidden after success) -->
        <div id="step-verify">
            <p>Verifying your reset link...</p>
            <div id="verify-status" class="message"></div>
        </div>
        
        <!-- Step 2: New password form (shown after verification) -->
        <div id="step-newpass" style="display:none;">
            <p>Enter your new password below:</p>
            <input type="password" id="new-password" placeholder="NEW PASSWORD" autocomplete="new-password">
            <input type="password" id="confirm-password" placeholder="CONFIRM PASSWORD" autocomplete="new-password">
            <button onclick="handleResetPassword()">UPDATE CREDENTIALS</button>
            <div id="reset-status" class="message"></div>
        </div>
        
        <!-- Step 3: Success message -->
        <div id="step-success" style="display:none;">
            <p class="success">‚úÖ PASSWORD UPDATED!</p>
            <p>Your password has been successfully reset.</p>
            <a class="back-link" onclick="window.location.href='index.html'">RETURN TO MAINFRAME</a>
        </div>
        
        <a class="back-link" onclick="window.location.href='index.html'">‚Üê BACK TO LOGIN</a>
    </div>

    <script>
        const supabaseUrl = 'https://wbdsmleccsxglvsgsqnw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndiZHNtbGVjY3N4Z2x2c2dzcW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MDMxNDIsImV4cCI6MjA4MzQ3OTE0Mn0.7IEkpvEDEvKAF2C3Lv6qU9omg6L7x-eVLyASxpyRXuk';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // Get the token from the URL
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = urlParams.get('access_token');
        const refreshToken = urlParams.get('refresh_token');
        const type = urlParams.get('type');
        
        // On page load, verify the token
        document.addEventListener('DOMContentLoaded', async () => {
            if (!accessToken || type !== 'recovery') {
                showError('Invalid or expired reset link.');
                return;
            }
            
            // Set the session with the recovery token
            const { error } = await supabase.auth.setSession({
                access_token: accessToken,
                refresh_token: refreshToken
            });
            
            if (error) {
                showError('Link expired or invalid. Please request a new reset link.');
            } else {
                // Token is valid, show password form
                document.getElementById('step-verify').style.display = 'none';
                document.getElementById('step-newpass').style.display = 'block';
            }
        });
        
        async function handleResetPassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const statusEl = document.getElementById('reset-status');
            
            statusEl.className = 'message';
            statusEl.innerHTML = '';
            
            // Validation
            if (!newPassword || !confirmPassword) {
                showError('Please fill in both fields.');
                return;
            }
            if (newPassword.length < 6) {
                showError('Password must be at least 6 characters.');
                return;
            }
            if (newPassword !== confirmPassword) {
                showError('Passwords do not match.');
                return;
            }
            
            // Update password using Supabase
            const { error } = await supabase.auth.updateUser({
                password: newPassword
            });
            
            if (error) {
                showError('Failed to update password: ' + error.message);
            } else {
                // Success
                document.getElementById('step-newpass').style.display = 'none';
                document.getElementById('step-success').style.display = 'block';
            }
        }
        
        function showError(message) {
            const statusEl = document.getElementById('reset-status') || document.getElementById('verify-status');
            statusEl.innerHTML = message;
            statusEl.className = 'message error';
        }
    </script>
</body>
</html>
