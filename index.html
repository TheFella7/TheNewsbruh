<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>The News Bruh - Neon Edition</title>
    <script src="https://www.paypal.com/sdk/js?client-id=AdgyoPwFv4kJ1HNnpD_lrCMykIBoboGuZJeADLgK-xBDZPPnsYAx7LPsPrK37jHZsgXDnb_ChvtCzI1h&currency=GBP"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #000; --neon: #39FF14; --neon-dim: #1a5e0b; --old-english: 'UnifrakturMaguntia', serif; --mono: 'Courier Prime', monospace; }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: var(--bg); color: var(--neon); font-family: var(--mono); display: flex; flex-direction: column; height: 100dvh; overflow: hidden; text-shadow: 0 0 5px var(--neon-dim); border: 2px solid var(--neon); box-shadow: inset 0 0 10px var(--neon-dim); border-radius: 4px; padding-bottom: env(safe-area-inset-bottom); }
        
        /* Account Overlay */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 3000; display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center; padding: 20px; }
        
        #how-to-play-overlay, #offline-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; }
        #how-to-play-box, #offline-box { width: 90%; max-width: 450px; background: #000; border: 2px solid var(--neon); padding: 25px; position: relative; box-shadow: 0 0 30px var(--neon-dim); max-height: 85vh; overflow-y: auto; text-align: center; }
        #close-htp, #close-offline { position: absolute; top: 10px; right: 15px; font-size: 1.8rem; cursor: pointer; font-weight: bold; color: var(--neon); text-shadow: 0 0 10px var(--neon); }
        .htp-header { font-family: var(--old-english); font-size: 2.2rem; text-align: center; margin-bottom: 5px; color: var(--neon); }
        .htp-sub { font-size: 0.6rem; text-align: center; margin-bottom: 20px; letter-spacing: 2px; opacity: 0.8; }
        .htp-section-title { font-size: 0.75rem; font-weight: bold; color: #fff; background: var(--neon-dim); padding: 4px 8px; margin: 15px 0 10px 0; display: inline-block; }
        .htp-content { font-size: 0.75rem; line-height: 1.5; color: #eee; }
        .cmd-list { list-style: none; }
        .cmd-list li { margin-bottom: 10px; padding-left: 10px; border-left: 1px solid var(--neon-dim); }
        .cmd-list code { color: var(--neon); font-weight: bold; font-size: 0.85rem; }

        #save-status { position: absolute; top: 10px; right: 10px; font-size: 0.6rem; color: var(--neon); opacity: 0; transition: opacity 0.5s; z-index: 1000; }
        #header { border-bottom: 2px solid var(--neon); padding: 10px; text-align: center; background: rgba(0,0,0,0.9); z-index: 10; position: relative; }
        .header-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .global-msg-count { font-size: 0.55rem; color: var(--neon); border: 1px solid var(--neon-dim); padding: 2px 5px; background: rgba(57, 255, 20, 0.05); }
        .chat-indicator { display: flex; align-items: center; gap: 5px; font-size: 0.6rem; color: var(--neon); cursor: pointer; padding: 5px; }
        .chat-badge { background: var(--neon); color: #000; border-radius: 10px; padding: 2px 6px; font-weight: bold; font-size: 0.5rem; min-width: 16px; text-align: center; box-shadow: 0 0 5px var(--neon); }
        .chat-badge.hidden { display: none; }
        h1 { font-family: var(--old-english); font-size: clamp(1.8rem, 6vw, 3rem); color: var(--neon); text-shadow: 0 0 15px var(--neon); margin: 2px 0; }
        .network-stats { font-size: 0.6rem; color: var(--neon); margin-top: 2px; letter-spacing: 1px; text-transform: uppercase; }
        .stats-dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 8px; border-bottom: 1px solid var(--neon); background: #050505; font-size: 0.75rem; text-align: left; z-index: 9; }
        .stat-item { display: flex; justify-content: space-between; padding: 0 10px; }
        #clicker-area { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 5; }
        #emoji-stack { position: relative; width: 150px; height: 150px; }
        .paper-emoji { position: absolute; font-size: 70px; display: none; filter: drop-shadow(0 0 8px var(--neon)); transition: all 0.3s ease; }
        #p1, #p2, #p3, #p4, #p5, #p6, #p7, #p8, #p9 { position: absolute; font-size: 70px; display: none; }
        #p1 { top: 0; left: 0; transform: rotate(-5deg); } #p2 { top: 5px; left: 25px; transform: rotate(10deg); } #p3 { top: 10px; left: 50px; transform: rotate(-8deg); }
        #p4 { top: 30px; left: -5px; transform: rotate(15deg); } #p5 { top: 35px; left: 20px; transform: rotate(2deg); } #p6 { top: 40px; left: 55px; transform: rotate(-12deg); }
        #p7 { top: 55px; left: 5px; transform: rotate(7deg); } #p8 { top: 60px; left: 30px; transform: rotate(-3deg); } #p9 { top: 70px; left: 50px; transform: rotate(20deg); }

        .falling-paper { position: fixed; top: -50px; font-size: 24px; pointer-events: none; z-index: 1; filter: drop-shadow(0 0 5px var(--neon-dim)); animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }
        .boost-control { margin-top: 20px; z-index: 100; text-align: center; }
        .btn-boost { background: var(--neon); color: #000; border: none; padding: 12px 24px; font-family: var(--mono); font-weight: bold; cursor: pointer; box-shadow: 0 0 15px var(--neon); }
        .btn-boost:disabled { background: #000; color: var(--neon-dim); box-shadow: none; cursor: not-allowed; border: 1px solid var(--neon-dim); }
        #boost-timer-display { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: var(--neon); text-shadow: 0 0 10px var(--neon); }
        #nps-display { font-size: 0.9rem; color: var(--neon); margin-top: 10px; font-weight: bold; text-shadow: 0 0 5px var(--neon-dim); }
        .floating-text { position: absolute; color: var(--neon); font-weight: bold; pointer-events: none; animation: floatUp 0.8s ease-out forwards; z-index: 101; white-space: nowrap; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }

        #tab-container { flex-grow: 1; padding: 20px; overflow-y: auto; display: none; border: 2px solid var(--neon); margin: 15px; background: rgba(0,0,0,0.95); z-index: 20; }
        #tab-title { text-transform: capitalize; font-family: var(--old-english); border-bottom: 1px solid var(--neon); margin-bottom: 15px; font-size: 1.5rem; }
        .active-tab { display: block !important; }

        #chat-container { display: flex; flex-direction: column; height: 280px; border-top: 2px solid var(--neon); background: #000; z-index: 50; transition: height 0.3s ease; }
        .chat-toggle { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background: rgba(57, 255, 20, 0.1); cursor: pointer; border-bottom: 1px solid var(--neon-dim); font-size: 0.7rem; font-weight: bold; }
        #chat-log { flex-grow: 1; overflow-y: auto; padding: 10px 15px; display: flex; flex-direction: column; gap: 8px; font-size: 0.75rem; }
        .chat-message { padding: 6px 10px; border-radius: 4px; background: rgba(57, 255, 20, 0.05); border-left: 2px solid var(--neon); animation: fadeIn 0.3s ease; position: relative; word-wrap: break-word;}
        .chat-time { position: absolute; right: 10px; top: 6px; font-size: 0.55rem; opacity: 0.6; }
        .chat-input-area { background: rgba(0,0,0,0.9); padding: 10px; border-top: 1px solid var(--neon-dim); }
        .command-hints { font-size: 0.75rem; margin-bottom: 8px; color: #FFFFFF; font-weight: bold; text-align: center; }
        .chat-input-container { display: flex; }
        #chat-input { flex-grow: 1; background: #000; border: 1px solid var(--neon); color: var(--neon); padding: 12px; font-family: var(--mono); font-size: 0.85rem; outline: none; }
        #chat-send { background: var(--neon); color: #000; border: none; padding: 0 20px; font-family: var(--mono); font-weight: bold; cursor: pointer; margin-left: 5px; }
        .upgrade-row { border: 1px solid var(--neon); margin-bottom: 10px; padding: 10px; background: rgba(57, 255, 20, 0.02); }
        .upgrade-info { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 10px; }
        .upgrade-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-upgrade { background: var(--neon); color: #000; border: none; padding: 8px; font-family: var(--mono); font-weight: bold; cursor: pointer; font-size: 0.7rem; }
        .btn-upgrade:disabled { opacity: 0.3; cursor: not-allowed; border: 1px solid var(--neon-dim); background: #000; color: var(--neon-dim); }
        .btn-action { background: var(--neon); color: #000; border: none; padding: 12px; font-family: var(--mono); font-weight: bold; cursor: pointer; width: 100%; margin-top: 8px;}
        .invest-stat { margin-bottom: 15px; padding: 10px; border: 1px dashed var(--neon-dim); font-size: 0.8rem; }
        .full-stat-line { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(57, 255, 20, 0.1); font-size: 0.75rem; }
        .rank-table { width: 100%; font-size: 0.7rem; border-collapse: collapse; margin-top: 10px; }
        .rank-table th { border-bottom: 1px solid var(--neon); padding: 8px; text-align: left; color: var(--neon); }
        .rank-table td { padding: 8px; border-bottom: 1px solid rgba(57, 255, 20, 0.1); }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="htp-header">The News Bruh</div>
    <div class="htp-sub">SYNC YOUR ACCOUNT</div>
    <p style="font-size: 0.8rem; margin-bottom: 20px;">Connect your wallet to load your progress on any browser.</p>
    <button class="btn-boost" onclick="connectAndSync()">CONNECT WALLET TO START</button>
    <p id="auth-status" style="margin-top: 15px; font-size: 0.6rem;"></p>
</div>

<div id="how-to-play-overlay">
    <div id="how-to-play-box">
        <div id="close-htp" onclick="document.getElementById('how-to-play-overlay').style.display='none'">X</div>
        <div class="htp-header">The News Bruh</div>
        <div class="htp-sub">SYSTEM VERSION 2.6 // NEON_OS</div>
        <div class="htp-content">
            <div class="htp-section-title">SYNCING</div>
            <p>Your progress is tied to your <b>Wallet Address</b>. Connect the same wallet on any device to resume your circulation.</p>
            <div class="htp-section-title">BASICS</div>
            <p>üóûÔ∏è <b>TAP</b> newspapers. üëë <b>PRESTIGE</b> for Bruh. üî• <b>BOOST</b> at 100%.</p>
        </div>
    </div>
</div>

<div id="offline-overlay">
    <div id="offline-box">
        <div class="htp-header">Offline Log</div>
        <div class="htp-sub">WELCOME BACK, BRUH</div>
        <div class="htp-content">
            <p>Offline: <b id="off-time">0h 0m</b></p>
            <p>üóûÔ∏è News: <b id="off-news">0</b> | üìà Yield: <b id="off-stake">0</b></p>
            <br><button class="btn-action" onclick="document.getElementById('offline-overlay').style.display='none'">RESUME</button>
        </div>
    </div>
</div>

<div id="save-status">CLOUD SAVED</div>

<div id="header">
    <div class="header-top-row">
        <div class="global-msg-count">MSG: <span id="msg-total-val">0</span></div>
        <div class="chat-indicator" onclick="toggleChat()">‚úâÔ∏è <span class="chat-badge hidden" id="unread-count">0</span></div>
    </div>
    <div class="network-stats">Online: <span id="online-count">1</span> | Total: <span id="total-players">...</span></div>
    <h1>The News Bruh</h1>
</div>

<div class="stats-dashboard">
    <div class="stat-item"><span>üóûÔ∏è News:</span> <span id="res-new">0</span></div>
    <div class="stat-item"><span>Lvl:</span> <span id="stat-level">1</span></div>
    <div class="stat-item"><span>üëë Bruh:</span> <span id="res-bruh">0</span></div>
    <div class="stat-item"><span>Exp:</span> <span><span id="stat-exp">0</span>/<span id="stat-next-exp">100</span></span></div>
    <div class="stat-item"><span>‚ö° Mult:</span> <span id="res-mult">1.0</span>x</div>
    <div class="stat-item"><span>Address:</span> <span id="user-short-addr" style="font-size:0.5rem">Not Sync</span></div>
</div>

<div id="clicker-area">
    <div id="emoji-stack">
        <div class="paper-emoji" id="p1" style="display:block">üóûÔ∏è</div><div class="paper-emoji" id="p2">üóûÔ∏è</div><div class="paper-emoji" id="p3">üóûÔ∏è</div>
        <div class="paper-emoji" id="p4">üóûÔ∏è</div><div class="paper-emoji" id="p5">üóûÔ∏è</div><div class="paper-emoji" id="p6">üóûÔ∏è</div>
        <div class="paper-emoji" id="p7">üóûÔ∏è</div><div class="paper-emoji" id="p8">üóûÔ∏è</div><div class="paper-emoji" id="p9">üóûÔ∏è</div>
    </div>
    <div class="boost-control">
        <div id="boost-timer-display" style="display:none">Boost: 15.0s</div>
        <button id="boost-btn" class="btn-boost" onclick="activateBoost(event)" disabled>[ Syncing... ]</button>
        <div id="nps-display">0.0 Nps</div>
    </div>
</div>

<div id="tab-container"><h2 id="tab-title"></h2><div id="tab-content"></div></div>
<div id="chat-container">
    <div class="chat-toggle" onclick="toggleChat()"><span>NETWORK CHAT</span><span id="chat-toggle-icon">‚ñº</span></div>
    <div id="chat-log"></div>
    <div class="chat-input-area">
        <div class="command-hints">!upgrades !rank !stats !stake !prestige !premium !close</div>
        <div class="chat-input-container">
            <input type="text" id="chat-input" placeholder="Message..." maxlength="100">
            <button id="chat-send" onclick="handleInput()">EXEC</button>
        </div>
    </div>
</div>

<script>
    const _URL = 'https://wbdsmleccsxglvsgsqnw.supabase.co';
    const _KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndiZHNtbGVjY3N4Z2x2c2dzcW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MDMxNDIsImV4cCI6MjA4MzQ3OTE0Mn0.7IEkpvEDEvKAF2C3Lv6qU9omg6L7x-eVLyASxpyRXuk';
    const sb = supabase.createClient(_URL, _KEY);
    const CRYPTO_WALLET = "0x7efCa6129eAFD3FAFf3134D74d3cA04ab2894983";

    let playerAddress = null; // This replaces the random UUID for cloud syncing
    let game = { playerName: "Anonymous", new: 0, totalNew: 0, bruh: 0, level: 1, exp: 0, nextExp: 100, totalExp: 0, clickPower: 1, autoNew: 0, clickCount: 0, boostActive: false, boostCooldown: 0, boostTimeLeft: 0, premiumMult: 1, stakedNews: 0, unclaimedNews: 0, lastSaveTime: Date.now(), upgrades: [{id:0,name:"Neon Paperboy",baseCost:15,count:0,power:1},{id:1,name:"Laser Press",baseCost:150,count:0,power:12},{id:2,name:"Cyber Bureau",baseCost:1800,count:0,power:65},{id:3,name:"Neural Network",baseCost:25000,count:0,power:320}]};

    let chat = { messages: [], unreadCount: 0, isOpen: true, currentTab: null };
    let boostAnimInterval = null;
    let lastTick = Date.now();
    let globalChannel = null;

    async function connectAndSync() {
        const status = document.getElementById('auth-status');
        if (!window.ethereum) { status.innerText = "No wallet found. Use a Web3 Browser (MetaMask/Trust)."; return; }
        
        try {
            const provider = new ethers.BrowserProvider(window.ethereum);
            const accounts = await provider.send("eth_requestAccounts", []);
            playerAddress = accounts[0].toLowerCase();
            
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('user-short-addr').innerText = playerAddress.substring(0,6)+"...";
            
            await loadCloud();
            initChat();
            startLoop();
        } catch (e) {
            status.innerText = "Connection rejected.";
        }
    }

    async function loadCloud() {
        const { data } = await sb.from('saves').select('game_data').eq('user_uuid', playerAddress).single();
        if (data) { 
            const saved = data.game_data;
            const offTime = Math.min((Date.now() - saved.lastSaveTime) / 1000, 43200);
            Object.assign(game, saved); 
            game.boostActive = false; game.boostTimeLeft = 0;
            if (offTime > 60) calculateOffline(offTime);
        }
        updateUI();
        updateTotalCount();
    }

    async function saveCloud() {
        if (!playerAddress) return;
        game.lastSaveTime = Date.now();
        await sb.from('saves').upsert({ user_uuid: playerAddress, game_data: game, updated_at: new Date() }, { onConflict: 'user_uuid' });
        const el = document.getElementById('save-status');
        el.style.opacity = 1; setTimeout(() => el.style.opacity = 0, 2000);
    }

    function initChat() {
        globalChannel = sb.channel('global_hub', { config: { presence: { key: playerAddress } } });
        globalChannel
            .on('broadcast', { event: 'chat' }, (p) => addChatMessage(p.payload.user, p.payload.msg, false, p.payload.uid === playerAddress, p.payload.time, p.payload.rawTime))
            .on('presence', { event: 'sync' }, () => { document.getElementById('online-count').innerText = Object.keys(globalChannel.presenceState()).length; })
            .subscribe(async (s) => { if (s === 'SUBSCRIBED') { await globalChannel.track({ online_at: new Date().toISOString() }); loadPersistentChat(); updateGlobalMsgCount(); } });
    }

    // -- REMAINDER OF GAME LOGIC (Exactly the same as previous) --
    function escapeHtml(t) { return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
    function format(n) { if (n < 1000) return n.toFixed(1); const s = ["k", "m", "b", "t"]; let e = Math.floor(Math.log10(n) / 3); if (e <= 4) return (n / Math.pow(10, e * 3)).toFixed(2) + (s[e - 1] || ""); let a = e - 5; let suf = ""; let i = a; while (i >= 0) { suf = String.fromCharCode(97 + (i % 26)) + suf; i = Math.floor(i / 26) - 1; } return (n / Math.pow(10, e * 3)).toFixed(2) + suf; }
    
    async function loadPersistentChat() {
        const yest = new Date(Date.now() - 86400000).toISOString();
        const { data } = await sb.from('chat_history').select('*').gt('created_at', yest).order('created_at', { ascending: true });
        if (data) { chat.messages = data.map(d => ({ s: d.sender, m: d.message, sys: false, time: new Date(d.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), rawTime: new Date(d.created_at).getTime() })); renderChat(); }
    }

    async function updateGlobalMsgCount() { const { count } = await sb.from('chat_history').select('*', { count: 'exact', head: true }); document.getElementById('msg-total-val').innerText = format(count || 0); }
    async function updateTotalCount() { const { count } = await sb.from('saves').select('*', { count: 'exact', head: true }); document.getElementById('total-players').innerText = format(count || 0); }

    function calculateOffline(s) {
        const m = (1 + game.bruh) * game.premiumMult;
        const g = game.autoNew * m * s; const y = game.stakedNews * 0.00001 * s;
        game.new += g; game.unclaimedNews += y; game.totalNew += g; addExp(g * 0.01);
        document.getElementById('off-time').innerText = `${Math.floor(s/3600)}h ${Math.floor((s%3600)/60)}m`;
        document.getElementById('off-news').innerText = format(g); document.getElementById('off-stake').innerText = format(y);
        document.getElementById('offline-overlay').style.display = 'flex';
    }

    function getMultiplier() { return (1 + game.bruh) * (game.boostActive ? 5 : 1) * game.premiumMult; }
    function getPrestigeCost() { return 500000 * Math.pow(5, game.bruh); }

    function updateUI() {
        document.getElementById('res-new').innerText = format(game.new);
        document.getElementById('res-bruh').innerText = format(game.bruh);
        document.getElementById('res-mult').innerText = format(getMultiplier());
        document.getElementById('stat-level').innerText = format(game.level);
        document.getElementById('stat-exp').innerText = format(game.exp);
        document.getElementById('stat-next-exp').innerText = format(game.nextExp);
        document.getElementById('nps-display').innerText = `${format(game.autoNew * getMultiplier())} Nps`;
        
        let stack = Math.max(1, Math.min(9, Math.ceil(game.clickCount / 10)));
        if (game.boostActive) stack = Math.max(1, Math.ceil((game.boostTimeLeft / 15) * 9));
        for (let i = 1; i <= 9; i++) document.getElementById('p' + i).style.display = i <= stack ? 'block' : 'none';

        const btn = document.getElementById('boost-btn');
        const tmr = document.getElementById('boost-timer-display');
        if (game.boostActive) { btn.style.display='none'; tmr.style.display='block'; tmr.innerText=`Boost: ${game.boostTimeLeft.toFixed(1)}s`; if(!boostAnimInterval) startBoostAnimation(); }
        else { btn.style.display='inline-block'; tmr.style.display='none'; stopBoostAnimation(); if (game.boostCooldown > 0) { btn.disabled=true; btn.innerText=`Cool: ${Math.ceil(game.boostCooldown)}s`; } else if (game.clickCount < 90) { btn.disabled=true; btn.innerText=`Stack: ${Math.floor((game.clickCount/90)*100)}%`; } else { btn.disabled=false; btn.innerText=`[ ACTIVATE BOOST ]`; } }
    }

    function startBoostAnimation() { boostAnimInterval = setInterval(() => { const p = document.createElement('div'); p.className='falling-paper'; p.innerText='üóûÔ∏è'; p.style.left=Math.random()*100+'vw'; p.style.animationDuration=(Math.random()*2+2)+'s'; document.body.appendChild(p); setTimeout(()=>p.remove(),4000); }, 150); }
    function stopBoostAnimation() { if(boostAnimInterval) { clearInterval(boostAnimInterval); boostAnimInterval = null; } }

    async function handleInput() {
        const inp = document.getElementById('chat-input'); let v = inp.value.trim(); if(!v) return;
        if (v.startsWith('!')) {
            let cmd = v.toLowerCase();
            const cont = document.getElementById('tab-container'); const clk = document.getElementById('clicker-area');
            if (cmd === '!close') { cont.classList.remove('active-tab'); clk.style.display = 'flex'; chat.currentTab = null; }
            else if (['!upgrades', '!stake', '!stats', '!rank', '!prestige', '!premium'].includes(cmd)) { cont.classList.add('active-tab'); clk.style.display = 'none'; document.getElementById('tab-title').innerText = cmd.substring(1); chat.currentTab = cmd; renderTab(cmd); }
        } else {
            const now = new Date(); const t = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            globalChannel.send({ type: 'broadcast', event: 'chat', payload: { user: game.playerName, msg: v, uid: playerAddress, time: t, rawTime: now.getTime() } });
            await sb.from('chat_history').insert({ sender: game.playerName, message: v });
            addChatMessage(game.playerName, v, false, true, t, now.getTime());
        }
        inp.value = '';
    }

    function renderTab(cmd) {
        const div = document.getElementById('tab-content');
        if (cmd === '!upgrades') { div.innerHTML = ''; game.upgrades.forEach(u => { let cost = Math.floor(u.baseCost * Math.pow(1.15, u.count)); let row = document.createElement('div'); row.className='upgrade-row'; row.innerHTML=`<div class="upgrade-info"><span><b>${u.name}</b> (Lv.${u.count})</span><span>+${u.power}/s</span></div><div class="upgrade-btns"><button class="btn-upgrade" ${game.new < cost ? 'disabled' : ''} onclick="buyUpgrade(${u.id})">+1: ${format(cost)}</button></div>`; div.appendChild(row); }); }
        else if (cmd === '!stake') { div.innerHTML = `<div class="invest-stat"><p>Invested: <b>${format(game.stakedNews)}</b></p><p>Yield: <b id="live-yield-val">${format(game.unclaimedNews)}</b></p></div><button class="btn-action" onclick="investAll()">INVEST ALL</button><button class="btn-action" onclick="claimYield()">CLAIM YIELD</button>`; }
        else if (cmd === '!prestige') { div.innerHTML = `<div class="invest-stat"><p>Bruh: <b>${format(game.bruh)}</b></p><p>Cost: <b>${format(getPrestigeCost())}</b></p></div><button class="btn-action" onclick="buyAllBruh()">PRESTIGE</button>`; }
        else if (cmd === '!stats') { div.innerHTML = `<div style="padding:10px;"><input id="name-in" value="${escapeHtml(game.playerName)}" maxlength="12" style="background:#000; color:var(--neon); border:1px solid var(--neon); width:100%; padding:10px;"><button class="btn-action" onclick="updateName()">UPDATE NAME</button></div>`; }
        else if (cmd === '!rank') { div.innerHTML = 'Loading...'; sb.from('saves').select('game_data').limit(10).then(({data}) => { if(data) { data.sort((a,b)=>b.game_data.bruh - a.game_data.bruh); let h = '<table class="rank-table"><tr><th>#</th><th>NAME</th><th>BRUH</th></tr>'; data.forEach((d,i) => h+=`<tr><td>${i+1}</td><td>${escapeHtml(d.game_data.playerName)}</td><td>${format(d.game_data.bruh)}</td></tr>`); div.innerHTML = h+'</table>'; } }); }
        else if (cmd === '!premium') { div.innerHTML = `<div class="invest-stat"><button class="btn-action" style="background:#8247e5;color:white;" onclick="payWithPolygon()">+5 BRUH (POLYGON)</button></div>`; }
    }

    function buyUpgrade(id) { const u = game.upgrades.find(x => x.id === id); const cost = Math.floor(u.baseCost * Math.pow(1.15, u.count)); if (game.new >= cost) { game.new -= cost; u.count++; game.autoNew += u.power; renderTab('!upgrades'); updateUI(); } }
    function updateName() { let n = document.getElementById('name-in').value.trim(); if(n) { game.playerName = n; saveCloud(); alert('Name updated!'); } }
    function investAll() { game.stakedNews += game.new; game.new = 0; renderTab('!stake'); }
    function claimYield() { game.new += game.unclaimedNews; game.unclaimedNews = 0; renderTab('!stake'); updateUI(); }
    function buyAllBruh() { const cost = getPrestigeCost(); if(game.new >= cost) { game.new -= cost; game.bruh++; game.level=1; game.exp=0; game.upgrades.forEach(u=>u.count=0); game.autoNew=0; renderTab('!prestige'); updateUI(); saveCloud(); } }

    async function payWithPolygon() {
        const provider = new ethers.BrowserProvider(window.ethereum); const signer = await provider.getSigner();
        const priceReq = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=matic-network&vs_currencies=gbp'); const priceData = await priceReq.json(); const polPrice = priceData['matic-network'].gbp; const amountToPay = (0.99 / polPrice).toFixed(6);
        try { const tx = await signer.sendTransaction({ to: CRYPTO_WALLET, value: ethers.parseEther(amountToPay) }); await tx.wait(); game.bruh += 5; saveCloud(); updateUI(); alert('Success!'); } catch(e) { alert('Failed'); }
    }

    function toggleChat() { chat.isOpen = !chat.isOpen; document.getElementById('chat-log').style.display = chat.isOpen ? 'flex' : 'none'; document.querySelector('.chat-input-area').style.display = chat.isOpen ? 'block' : 'none'; document.getElementById('chat-container').style.height = chat.isOpen ? '280px' : '40px'; updateUI(); }
    function addChatMessage(s, m, sys, self, time, raw) { chat.messages.push({ s, m, sys, time, raw }); renderChat(); }
    function renderChat() { const log = document.getElementById('chat-log'); log.innerHTML = chat.messages.map(m => `<div class="chat-message"><span class="chat-time">${m.time}</span><b>${escapeHtml(m.s)}:</b> ${escapeHtml(m.m)}</div>`).join(''); log.scrollTop = log.scrollHeight; }

    document.getElementById('clicker-area').onmousedown = (e) => {
        if (!game.boostActive) { if (game.clickCount < 90) game.clickCount += 2; if (game.clickCount >= 90 && game.boostCooldown <= 0) activateBoost(); }
        else { game.boostTimeLeft = Math.min(15, game.boostTimeLeft + 0.3); }
        let gain = 1 * getMultiplier(); game.new += gain; game.totalNew += gain; addExp(gain * 0.05);
        const f = document.createElement('div'); f.className = 'floating-text'; f.innerText = `+${format(gain)}`; f.style.left = e.clientX + 'px'; f.style.top = e.clientY + 'px'; document.body.appendChild(f); setTimeout(() => f.remove(), 800); updateUI();
    };

    function addExp(a) { game.exp += a; game.totalExp += a; while (game.exp >= game.nextExp) { game.exp -= game.nextExp; game.level++; game.nextExp *= 1.5; } }
    function activateBoost(e) { if(e) e.stopPropagation(); game.boostActive = true; game.boostTimeLeft = 15; updateUI(); }

    function startLoop() {
        setInterval(() => {
            const now = Date.now(); const dt = (now - lastTick) / 1000; lastTick = now;
            let gain = game.autoNew * getMultiplier() * dt; if (gain > 0) { game.new += gain; game.totalNew += gain; addExp(gain * 0.01); }
            if (game.stakedNews > 0) game.unclaimedNews += (game.stakedNews * 0.00001 * dt);
            if (game.boostActive) { game.boostTimeLeft -= dt; if (game.boostTimeLeft <= 0) { game.boostActive = false; game.clickCount = 0; game.boostCooldown = 600; } }
            else if (game.clickCount > 0) { game.clickCount = Math.max(0, game.clickCount - (2 * dt)); }
            if (game.boostCooldown > 0) game.boostCooldown = Math.max(0, game.boostCooldown - dt);
            updateUI();
        }, 100);
        setInterval(saveCloud, 15000);
    }
    
    document.getElementById('chat-input').onkeypress = (e) => { if (e.key === 'Enter') handleInput(); };
</script>
</body>
</html>
